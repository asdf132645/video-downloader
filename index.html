<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Video Downloader (Network Sniffer)</title>
    <style>
        body {
            padding: 24px;
            font-family: system-ui;
            background: #f4f5f7;
        }
        .wrap {
            width: 1100px;
            margin: 0 auto;
            padding: 20px;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 2px 14px rgba(0,0,0,0.08);
        }
        h2 {
            margin-top: 0;
            margin-bottom: 12px;
        }
        .toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .toolbar input {
            flex: 1;
            padding: 9px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 14px;
        }
        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }
        .btn-primary {
            background: #2a2e9d;
            color: #fff;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: default;
        }
        .webview-wrap {
            margin-top: 10px;
            margin-bottom: 14px;
        }
        webview {
            width: 100%;
            height: 480px;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        .controls-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            margin-bottom: 4px;
        }
        select {
            font-size: 13px;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .status {
            font-size: 12px;
            color: #555;
            margin-top: 2px;
        }
        .progress-wrap {
            margin-top: 10px;
        }
        .progress-text {
            margin-bottom: 4px;
            font-size: 12px;
            color: #444;
        }
        .progress-base {
            width: 100%;
            height: 8px;
            border-radius: 8px;
            background: #ddd;
        }
        .progress-bar {
            width: 0%;
            height: 8px;
            border-radius: 8px;
            background: #2a2e9d;
            transition: 0.2s;
        }
        pre {
            background: #fafafa;
            border: 1px solid #ddd;
            padding: 10px;
            white-space: pre-wrap;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 13px;
            height: 200px;
            overflow-y: auto;
        }
        .hidden {
            display: none;
        }
        .media-select-label {
            font-size: 12px;
            color: #444;
        }
    </style>
</head>

<body>
<div class="wrap">
    <h2>Video Downloader (Network Sniffer)</h2>

    <!-- ğŸ”¹ ìƒë‹¨ ì£¼ì†Œ ì…ë ¥ + ì´ë™ ë²„íŠ¼ -->
    <div class="toolbar">
        <input id="address" type="text"
               placeholder="ì´ë™í•  ì£¼ì†Œ ì…ë ¥ (ì˜ˆ: https://ydtour23.com)" />
        <button class="btn btn-secondary" id="go-btn">ì´ë™</button>
    </div>

    <!-- ğŸ”¹ webview -->
    <div class="webview-wrap">
        <webview
                id="browser"
                src="https://www.google.com"
                allowpopups
        ></webview>
    </div>

    <!-- ğŸ”¹ ë‹¤ìš´ë¡œë“œ ì»¨íŠ¸ë¡¤ -->
    <div class="controls-row">
        <select id="mode">
            <option value="auto">auto (ì¶”ì²œ)</option>
            <option value="direct">directë§Œ</option>
            <option value="ytdlp">yt-dlp ê°•ì œ</option>
        </select>

        <!-- ğŸ”¥ íŒŒì¼ëª… ì…ë ¥ì°½ ì¶”ê°€ -->
        <input
                id="file-name"
                type="text"
                placeholder="ì €ì¥í•  íŒŒì¼ëª… (í™•ì¥ì ì œì™¸)"
                style="width:200px;padding:7px;border-radius:6px;border:1px solid #ddd"
        />
        <!-- ê°ì§€ëœ ë¯¸ë””ì–´ URL ì„ íƒ -->
        <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
            <span class="media-select-label">ê°ì§€ëœ ë¯¸ë””ì–´ URL</span>
            <select id="media-select" class="hidden"></select>
        </div>

        <button class="btn btn-primary" id="download-btn" disabled>
            ì„ íƒí•œ ë¯¸ë””ì–´ ë‹¤ìš´ë¡œë“œ
        </button>
    </div>

    <div class="status" id="status">
        webviewì—ì„œ ì¬ìƒë˜ëŠ” ë™ì˜ìƒ/ìŠ¤íŠ¸ë¦¼ ë„¤íŠ¸ì›Œí¬ë¥¼ ê°ì§€í•©ë‹ˆë‹¤.
    </div>

    <!-- ğŸ”¹ ì§„í–‰ë¥  Progress UI -->
    <div class="progress-wrap">
        <div class="progress-text" id="progress-text">0%</div>
        <div class="progress-base">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
    </div>

    <!-- ğŸ”¹ ë¡œê·¸ ì¶œë ¥ ì˜ì—­ -->
    <pre id="log"></pre>
</div>

<script>
    const { ipcRenderer } = require("electron");

    let currentPageUrl = null;
    /** @type {{url:string, resourceType:string}[]} */
    let mediaList = [];

    function normalizeUrl(input) {
        if (!input) return "";
        if (/^https?:\/\//i.test(input)) return input;
        return "https://" + input;
    }

    function appendLog(el, text) {
        const now = new Date();
        const ts = now.toISOString().replace("T", " ").slice(0, 19);
        el.textContent = `[${ts}] ${text}\n\n` + el.textContent;
    }

    function truncateUrl(url, max = 80) {
        if (!url) return "";
        if (url.length <= max) return url;
        return url.slice(0, max - 3) + "...";
    }

    window.addEventListener("DOMContentLoaded", () => {
        const webview = document.getElementById("browser");
        const address = document.getElementById("address");
        const goBtn = document.getElementById("go-btn");
        const downloadBtn = document.getElementById("download-btn");
        const modeSel = document.getElementById("mode");
        const mediaSelect = document.getElementById("media-select");
        const statusEl = document.getElementById("status");
        const logEl = document.getElementById("log");
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");

        /* ===========================
              ğŸ”¥ SSE Progress
        =========================== */
        const evtSource = new EventSource("http://localhost:3000/api/progress");
        evtSource.onmessage = (e) => {
            try {
                const data = JSON.parse(e.data);
                const pct = Number(data.pct || 0);
                const size = data.size || "";
                progressBar.style.width = pct + "%";
                progressText.textContent =
                    pct + "% " + (size ? `(${size})` : "");
            } catch (err) {
                console.error("SSE parse error:", err);
            }
        };

        /* ===========================
              ğŸ”¥ ì£¼ì†Œì°½ ì´ë™
        =========================== */
        goBtn.addEventListener("click", () => {
            const raw = address.value.trim();
            const url = normalizeUrl(raw);
            if (!url) return;
            webview.loadURL(url);
        });

        address.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                goBtn.click();
            }
        });

        /* ===========================
              ğŸ”¥ webview ë“±ë¡ (ë„¤íŠ¸ì›Œí¬ í›…)
        =========================== */
        webview.addEventListener("did-attach", () => {
            const wcId = webview.getWebContentsId();
            if (wcId) {
                ipcRenderer.send("register-webview", wcId);
            }
        });

        /* ===========================
              ğŸ”¥ webview URL ë³€ê²½ ê°ì§€
        =========================== */
        function handleNavigate(e) {
            const url = e.url;
            currentPageUrl = url;
            address.value = url;

            // í˜ì´ì§€ ë°”ë€” ë•Œë§ˆë‹¤ ê°ì§€ ëª©ë¡ ë¦¬ì…‹
            mediaList = [];
            renderMediaList();
            statusEl.textContent =
                "í˜ì´ì§€ ë¡œë”© ì¤‘... ë„¤íŠ¸ì›Œí¬ì—ì„œ ë¯¸ë””ì–´ë¥¼ ê°ì§€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.";

            appendLog(logEl, `[NAVIGATE] ${url}`);
        }

        webview.addEventListener("did-navigate", handleNavigate);
        webview.addEventListener("did-navigate-in-page", handleNavigate);

        /* ===========================
              ğŸ”¥ main â†’ renderer : ë¯¸ë””ì–´ ê°ì§€ ì´ë²¤íŠ¸
        =========================== */
        ipcRenderer.on("media-detected", (event, payload) => {
            const { url, resourceType } = payload || {};
            if (!url) return;

            // ì¤‘ë³µ ì œê±°
            if (mediaList.find((m) => m.url === url)) return;

            mediaList.push({ url, resourceType: resourceType || "" });
            renderMediaList();

            statusEl.textContent =
                `ğŸ¬ ë¯¸ë””ì–´ ê°ì§€ë¨ (ì´ ${mediaList.length}ê°œ)`;
            appendLog(
                logEl,
                `[MEDIA] ${resourceType || "unknown"}\n${url}`
            );
        });

        /* ===========================
              ğŸ”¥ ê°ì§€ëœ ë¯¸ë””ì–´ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        =========================== */
        function renderMediaList() {
            mediaSelect.innerHTML = "";

            if (!mediaList.length) {
                mediaSelect.classList.add("hidden");
                downloadBtn.disabled = true;
                return;
            }

            mediaList.forEach((item, idx) => {
                const opt = document.createElement("option");
                opt.value = item.url;
                opt.textContent = `${idx + 1}. ${truncateUrl(item.url, 100)}`;
                mediaSelect.appendChild(opt);
            });

            mediaSelect.classList.remove("hidden");
            downloadBtn.disabled = false;
        }

        /* ===========================
              ğŸ”¥ ì„ íƒí•œ ë¯¸ë””ì–´ ë‹¤ìš´ë¡œë“œ
        =========================== */
        downloadBtn.addEventListener("click", async () => {
            if (!mediaList.length) return;

            const targetUrl =
                mediaSelect.value || mediaList[0].url;
            const mode = modeSel.value;

            // ğŸ”¥ ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼ëª… ì…ë ¥ê°’
            const customName = document.getElementById("file-name").value.trim();

            downloadBtn.disabled = true;
            const originalText = downloadBtn.textContent;
            downloadBtn.textContent = "ë‹¤ìš´ë¡œë“œ ì¤‘...";

            progressBar.style.width = "0%";
            progressText.textContent = "0%";

            appendLog(
                logEl,
                `POST /api/download\n` +
                `URL: ${targetUrl}\n` +
                `fileName:${customName}\n` +
                `mode: ${mode}\n` +
                `referer: ${currentPageUrl || targetUrl}\n`
            );

            try {
                const resp = await fetch("http://localhost:3000/api/download", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        url: targetUrl,
                        fileName: customName,
                        mode,
                        referer: currentPageUrl || targetUrl,
                    }),
                });

                const data = await resp.json();
                const logText = data.log || JSON.stringify(data, null, 2);

                appendLog(
                    logEl,
                    `=== /api/download ì‘ë‹µ ===\n${logText}\n`
                );
            } catch (err) {
                appendLog(logEl, "âŒ ìš”ì²­ ì‹¤íŒ¨: " + err);
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.textContent = originalText;
            }
        });
    });
</script>

</body>
</html>
